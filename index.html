<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8" />
    <title>a7-home</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/4.1.0/rx.all.min.js"></script>
    <script src="rx-facebook.js"></script>
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>

    <script>
      window.fbAsyncInit = function() {
        FB.init({
          //appId      : '188623204850625', // production
          //appId      : '190564001323212', // testing
          //appId      : '145634995501895', // graph api explorer
          appId      : '1587345544879203', // RxF4c36ook­-­test
          xfbml      : true,
          version    : 'v2.3'
        });

        function moveRef(from, to) {
          from.once('value', function (snap) {
            to.set(snap.val(), function (error) {
              if (!error) {
                from.remove();
              } else {
                console.error(error);
              }
            });
          });
        }

        function statusChangeCallback(response) {
          if (response.status === 'connected') {
            console.log(response.status);
            //var groupId = "565500876822283"; // a7.home.tw
            //var groupId = "504080216343231"; // farglory.a7home
            var groupId = "1444562472508601"; // ia7home
            //var groupId = "194889130690889"; // farglory.a7
            rxFbApi("/" + groupId + "/feed?fields=from,message").flatMap(function (post) {
              return Rx.Observable.of(post).concatMap(rxFbApi(post.id + "/comments?fields=from,message,created_time,updated_time&filter=stream"));
            })
            .zip(Rx.Observable.interval(3), function(a, b) { return a; })
            .subscribe(function (msg) {
              console.log(msg);

              //var rootRef = new Firebase('https://a7-home.firebaseio.com/');
              //var messagesRef = new Firebase('https://a7-home.firebaseio.com/').child("messages");
              new Firebase('https://a7-home.firebaseio.com/').child(groupId).child("messages").child(msg.id).set(msg);
            });
          } else if (response.status === 'not_authorized') {
            console.log(response.status);
          } else {
            console.log(response.status);
          }
        }

         FB.getLoginStatus(function(response) {
             statusChangeCallback(response);
         });
      };

      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });
      }

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "https://connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);

       }(document, 'script', 'facebook-jssdk'));
    </script>
  </head>
  <body>
    <fb:login-button scope="public_profile,email,user_posts,user_groups" onlogin="checkLoginState();">
    </fb:login-button>
  </body>
</html>
